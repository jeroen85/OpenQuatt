# ==============================================================================
# OpenQuatt â€“ openquatt.yaml
# Version: v0.12.1
# Date: 2026-02-12
#
# Purpose:
# - Top-level ESPHome config and package includes.
# - Keeps boot/runtime services and shared diagnostics in one place.
# ==============================================================================
substitutions: !include openquatt/oq_substitutions.yaml

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  project:
    name: ${project_name}
    version: ${project_version}
  min_version: 2025.11.0
  name_add_mac_suffix: false
  includes:
    - openquatt/includes/hp_perf_map.h

esp32:
  board: ${esp_board}
  flash_size: ${esp_flash_size}
  variant: ${esp_variant}
  framework:
    type: esp-idf
    version: recommended
    ## Custom sdkconfig options
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_BT_ENABLED: n

# Enable logging
logger:
  level: DEBUG
  baud_rate: 0
  runtime_tag_levels: true

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key
  reboot_timeout: 0s

ota:
  platform: esphome
  password: !secret ota_password

# ==============================================================================
# NETWORK
# ==============================================================================
wifi:
  manual_ip:
    gateway: !secret wifi_gateway
    subnet: !secret wifi_subnet
    static_ip: !secret ip_openquatt
    dns1: 8.8.8.8
    dns2: 1.1.1.1
  networks:
    - ssid: !secret wifi_ssid
      password: !secret wifi_password
  fast_connect: true
  min_auth_mode: wpa2
  ap:
    ssid: "OpenQuatt"
    password: "openquatt"

captive_portal:

# ==============================================================================
# PACKAGES
# Package load order is intentional:
# 1) Supervisory/state
# 2) Demand strategy
# 3) Actuation layers (heat/flow/boiler)
# 4) Aggregation/energy telemetry
# 5) External inputs (CIC)
# 6) Local sensors/source selection
# 7) Web UI
# 8) Per-HP hardware adapters
# ==============================================================================
packages: !include openquatt/oq_packages.yaml

# ==============================================================================
# MODBUS
# ==============================================================================
uart:
  - id: uart_bus
    tx_pin: ${uart_tx_pin}
    rx_pin: ${uart_rx_pin}
    baud_rate: 19200
    data_bits: 8
    stop_bits: 1
    parity: EVEN
    rx_full_threshold: 1
    rx_timeout: 1

modbus:
  - uart_id: uart_bus
    id: mod_bus
    flow_control_pin: ${uart_rts_pin}
    send_wait_time: 100ms

# ==============================================================================
# DEFAULT ENTITIES
# ==============================================================================
binary_sensor:
  - platform: status
    name: Status
    icon: mdi:check-circle-outline
    entity_category: diagnostic
    web_server:
      sorting_group_id: oq_diagnostics

sensor:
  - platform: uptime
    name: Uptime
    id: uptime_sensor
    icon: mdi:timer-outline
    update_interval: 60s
    device_class: duration
    unit_of_measurement: s
    entity_category: diagnostic
    web_server:
      sorting_group_id: oq_diagnostics
  - platform: wifi_signal
    name: WiFi Signal
    icon: mdi:wifi-arrow-left-right
    update_interval: 300s
    entity_category: diagnostic
    web_server:
      sorting_group_id: oq_diagnostics

button:
  - platform: restart
    name: Restart
    icon: mdi:restart
    id: restart_switch
    web_server:
      sorting_group_id: oq_diagnostics

  - platform: safe_mode
    name: Safe mode
    icon: mdi:shield-alert
    id: safe_mode_button
    web_server:
      sorting_group_id: oq_diagnostics

text_sensor:
  - platform: wifi_info
    ip_address:
      name: IP Address
      icon: mdi:ip-network-outline
      entity_category: diagnostic
      web_server:
        sorting_group_id: oq_diagnostics
    ssid:
      name: WiFi SSID
      icon: mdi:wifi
      entity_category: diagnostic
      web_server:
        sorting_group_id: oq_diagnostics
  - platform: template
    id: oq_project_version_text
    name: OpenQuatt Version
    icon: mdi:tag-text-outline
    entity_category: diagnostic
    update_interval: never
    lambda: |-
      return {"${project_version}"};
    web_server:
      sorting_group_id: oq_diagnostics
  - platform: version
    name: ESPHome Version
    icon: mdi:information-outline
    hide_timestamp: true
    entity_category: diagnostic
    web_server:
      sorting_group_id: oq_diagnostics

# ==============================================================================
# DEBUG LEVEL SELECT
# ==============================================================================
select:
  - platform: template
    name: "Debug Level"
    id: debug_level_select
    icon: mdi:lan
    web_server:
      sorting_group_id: oq_diagnostics
    entity_category: diagnostic
    optimistic: true
    restore_value: true
    options: [NONE, ERROR, WARN, INFO, CONFIG, DEBUG]
    initial_option: INFO
    on_value:
      then:
        - lambda: |-
            int lvl =
              (x == "NONE")    ? 0 :
              (x == "ERROR")   ? 1 :
              (x == "WARN")    ? 2 :
              (x == "INFO")    ? 3 :
              (x == "CONFIG")  ? 4 :
                                 5;  // DEBUG

            esphome::logger::global_logger->set_log_level(lvl);

  - platform: template
    name: "Debug Level Modbus"
    id: debug_level_modbus_master
    icon: mdi:lan
    web_server:
      sorting_group_id: oq_diagnostics
    entity_category: diagnostic
    optimistic: true
    restore_value: true
    options: [NONE, ERROR, WARN, INFO, CONFIG, DEBUG]
    initial_option: WARN
    on_value:
      then:
        - lambda: |-
            int lvl =
              (x == "NONE")    ? 0 :
              (x == "ERROR")   ? 1 :
              (x == "WARN")    ? 2 :
              (x == "INFO")    ? 3 :
              (x == "CONFIG")  ? 4 :
                                 5;  // DEBUG

            auto *logger = esphome::logger::global_logger;

            logger->set_log_level("modbus", lvl);
            logger->set_log_level("modbus_controller", lvl);
