# ==============================================================================
# OpenQuatt - Home Assistant Dynamic Source Proxies
# ==============================================================================
#
# Purpose:
#   - User can enter source entity IDs in HA input_text helpers.
#   - This package publishes stable proxy sensors consumed by OpenQuatt ESPHome:
#       sensor.openquatt_ext_outdoor_temperature
#       sensor.openquatt_ext_room_setpoint
#       sensor.openquatt_ext_room_temperature
#
# Install (Home Assistant):
#   1) Enable packages in configuration.yaml:
#        homeassistant:
#          packages: !include_dir_named packages
#   2) Copy this file to: /config/packages/openquatt_dynamic_sources.yaml
#   3) Adjust initial input_text values to your own source entity IDs.
#   4) Reload Template Entities (or restart Home Assistant).
#
# Notes:
#   - Trigger interval is 15s to support dynamic entity_id references.
#   - Invalid/missing source values become Unavailable (no sticky fallback cache).
#   - Setpoint/room-temperature proxies also support climate attributes:
#       temperature / current_temperature
# ==============================================================================

input_text:
  openquatt_source_outdoor_temperature:
    name: OpenQuatt source outdoor temperature
    icon: mdi:thermometer
    mode: text
    max: 100
    initial: sensor.outdoor_temperature

  openquatt_source_room_setpoint:
    name: OpenQuatt source room setpoint
    icon: mdi:thermostat
    mode: text
    max: 100
    initial: sensor.thermostat_setpoint

  openquatt_source_room_temperature:
    name: OpenQuatt source room temperature
    icon: mdi:home-thermometer
    mode: text
    max: 100
    initial: sensor.thermostat_room_temperature

template:
  - trigger:
      - platform: state
        entity_id:
          - input_text.openquatt_source_outdoor_temperature
          - input_text.openquatt_source_room_setpoint
          - input_text.openquatt_source_room_temperature
      - platform: time_pattern
        seconds: "/15"
    sensor:
      - name: OpenQuatt Ext Outdoor Temperature
        unique_id: openquatt_ext_outdoor_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        availability: >-
          {% set entity = states('input_text.openquatt_source_outdoor_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set val = raw | replace(',', '.') | float(none) if raw else none %}
          {{ val is not none }}
        state: >-
          {% set entity = states('input_text.openquatt_source_outdoor_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set val = raw | replace(',', '.') | float(none) if raw else none %}
          {{ val if val is not none else 0 }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_outdoor_temperature') | trim }}

      - name: OpenQuatt Ext Room Setpoint
        unique_id: openquatt_ext_room_setpoint
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermostat
        availability: >-
          {% set entity = states('input_text.openquatt_source_room_setpoint') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val is not none }}
        state: >-
          {% set entity = states('input_text.openquatt_source_room_setpoint') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val if val is not none else 0 }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_room_setpoint') | trim }}

      - name: OpenQuatt Ext Room Temperature
        unique_id: openquatt_ext_room_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:home-thermometer
        availability: >-
          {% set entity = states('input_text.openquatt_source_room_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'current_temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val is not none }}
        state: >-
          {% set entity = states('input_text.openquatt_source_room_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'current_temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val if val is not none else 0 }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_room_temperature') | trim }}

    binary_sensor:
      - name: OpenQuatt Ext Outdoor Temperature Valid
        unique_id: openquatt_ext_outdoor_temperature_valid
        icon: mdi:check-decagram
        state: >-
          {% set entity = states('input_text.openquatt_source_outdoor_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set val = raw | replace(',', '.') | float(none) if raw else none %}
          {{ val is not none }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_outdoor_temperature') | trim }}

      - name: OpenQuatt Ext Room Setpoint Valid
        unique_id: openquatt_ext_room_setpoint_valid
        icon: mdi:check-decagram
        state: >-
          {% set entity = states('input_text.openquatt_source_room_setpoint') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val is not none }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_room_setpoint') | trim }}

      - name: OpenQuatt Ext Room Temperature Valid
        unique_id: openquatt_ext_room_temperature_valid
        icon: mdi:check-decagram
        state: >-
          {% set entity = states('input_text.openquatt_source_room_temperature') | trim %}
          {% set raw = states(entity) | trim if entity else '' %}
          {% set state_val = raw | replace(',', '.') | float(none) if raw else none %}
          {% set attr_val = state_attr(entity, 'current_temperature') | float(none) if entity else none %}
          {% set val = state_val if state_val is not none else attr_val %}
          {{ val is not none }}
        attributes:
          source_entity: >-
            {{ states('input_text.openquatt_source_room_temperature') | trim }}
