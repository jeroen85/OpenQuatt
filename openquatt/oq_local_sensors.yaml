# ==============================================================================
# OpenQuatt - Local Sensors (on-device)
# ==============================================================================
#
# Goal:
#   Host local physical sensors and provide selector-based merged signals
#   that can replace external feed values for core control logic.
#
# Current scope:
#   - DS18B20 local water supply temperature (1-Wire on configured GPIO)
#   - Source selectors for water/flow/outside/room inputs
#   - Merged outputs consumed by control packages
#
# ==============================================================================

one_wire:
  - platform: gpio
    pin: ${ds18b20_pin}

select:
  - platform: template
    name: "Water Supply Source"
    id: water_supply_source
    icon: mdi:source-branch
    entity_category: config
    optimistic: true
    restore_value: true
    options:
      - Local
      - CIC
    initial_option: Local
    web_server:
      sorting_group_id: oq_cic

  - platform: template
    name: "Flow Source"
    id: flow_source
    icon: mdi:source-branch
    entity_category: config
    optimistic: true
    restore_value: true
    options:
      - Outdoor unit
      - CIC
    initial_option: Outdoor unit
    web_server:
      sorting_group_id: oq_cic

  - platform: template
    name: "Outside Temperature Source"
    id: outside_temp_source
    icon: mdi:source-branch
    entity_category: config
    optimistic: true
    restore_value: true
    options:
      - Outdoor unit
      - HA input
    initial_option: Outdoor unit
    web_server:
      sorting_group_id: oq_cic

  - platform: template
    name: "Room Temperature Source"
    id: room_temp_source
    icon: mdi:source-branch
    entity_category: config
    optimistic: true
    restore_value: true
    options:
      - CIC
      - HA input
    initial_option: CIC
    web_server:
      sorting_group_id: oq_cic

  - platform: template
    name: "Room Setpoint Source"
    id: room_setpoint_source
    icon: mdi:source-branch
    entity_category: config
    optimistic: true
    restore_value: true
    options:
      - CIC
      - HA input
    initial_option: CIC
    web_server:
      sorting_group_id: oq_cic

sensor:
  - platform: dallas_temp
    id: water_supply_temp_esp
    name: "Water Supply Temp"
    icon: mdi:thermometer
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 5s
    web_server:
      sorting_group_id: oq_temperatures

  - platform: template
    id: water_supply_temp_selected
    name: "Water Supply Temp (Selected)"
    icon: mdi:water-thermometer
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 2s
    lambda: |-
      const auto source = id(water_supply_source).state;
      if (source == "CIC") {
        if (id(water_supply_temp_cic).has_state()) return id(water_supply_temp_cic).state;
        return NAN;
      }
      if (source == "Local") {
        if (id(water_supply_temp_esp).has_state()) return id(water_supply_temp_esp).state;
        return NAN;
      }
      return NAN;
    web_server:
      sorting_group_id: oq_temperatures

  - platform: template
    id: flow_rate_selected
    name: "Flow average (Selected)"
    icon: mdi:waves
    unit_of_measurement: "L/h"
    device_class: volume_flow_rate
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 1s
    lambda: |-
      const auto source = id(flow_source).state;
      if (source == "CIC") {
        if (id(flow_rate_cic).has_state()) return id(flow_rate_cic).state;
        return NAN;
      }
      if (source == "Outdoor unit") {
        if (id(flow_rate_hp_avg).has_state()) return id(flow_rate_hp_avg).state;
        return NAN;
      }
      return NAN;
    web_server:
      sorting_group_id: oq_hydraulics

  - platform: template
    id: outside_temp_selected
    name: "Outside Temperature (Selected)"
    icon: mdi:thermometer
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    update_interval: 10s
    lambda: |-
      const auto source = id(outside_temp_source).state;
      if (source == "HA input") {
        if (id(outside_temp_ha).has_state()) return id(outside_temp_ha).state;
        return NAN;
      }
      if (source == "Outdoor unit") {
        if (id(outside_temp_hp_avg).has_state()) return id(outside_temp_hp_avg).state;
        return NAN;
      }
      return NAN;
    web_server:
      sorting_group_id: oq_temperatures

  - platform: template
    id: room_temp_selected
    name: "Room Temperature (Selected)"
    icon: mdi:home-thermometer
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      const auto source = id(room_temp_source).state;
      if (source == "HA input") {
        if (id(thermostat_room_temp_ha).has_state()) return id(thermostat_room_temp_ha).state;
        return NAN;
      }
      if (source == "CIC") {
        if (id(ot_room_temp).has_state()) return id(ot_room_temp).state;
        return NAN;
      }
      return NAN;
    web_server:
      sorting_group_id: oq_temperatures

  - platform: template
    id: room_setpoint_selected
    name: "Room Setpoint (Selected)"
    icon: mdi:thermostat
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      const auto source = id(room_setpoint_source).state;
      if (source == "HA input") {
        if (id(thermostat_setpoint_ha).has_state()) return id(thermostat_setpoint_ha).state;
        return NAN;
      }
      if (source == "CIC") {
        if (id(ot_room_setpoint).has_state()) return id(ot_room_setpoint).state;
        return NAN;
      }
      return NAN;
    web_server:
      sorting_group_id: oq_temperatures
