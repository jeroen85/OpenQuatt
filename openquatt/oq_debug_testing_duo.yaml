# ==============================================================================
# OpenQuatt - Debug / Test Tools (duo extension)
# ==============================================================================
# Adds the HP2 Modbus read button to the shared debug module.
# ==============================================================================

button:
  - platform: template
    id: oq_debug_modbus_read_hp2
    name: "Debug Read HP2 register"
    icon: mdi:database-search
    entity_category: diagnostic
    web_server:
      sorting_group_id: oq_diagnostics
    on_press:
      - lambda: |-
          using namespace esphome::modbus_controller;
          const uint16_t reg = (uint16_t) lroundf(id(oq_debug_modbus_register).state);
          auto cmd = ModbusCommandItem::create_read_command(
              id(hp2), ModbusRegisterType::HOLDING, reg, 1,
              [reg](ModbusRegisterType, uint16_t, const std::vector<uint8_t> &data) {
                if (data.size() < 2) {
                  id(oq_debug_modbus_last_target).publish_state("HP2 reg " + std::to_string(reg));
                  id(oq_debug_modbus_last_raw).publish_state("ERR: short response");
                  return;
                }
                const uint16_t u16 = (uint16_t(data[0]) << 8) | uint16_t(data[1]);
                const int16_t s16 = (int16_t) u16;
                char raw[20];
                snprintf(raw, sizeof(raw), "0x%02X 0x%02X", data[0], data[1]);
                id(oq_debug_modbus_u16).publish_state((float) u16);
                id(oq_debug_modbus_s16).publish_state((float) s16);
                id(oq_debug_modbus_last_target).publish_state("HP2 reg " + std::to_string(reg));
                id(oq_debug_modbus_last_raw).publish_state(raw);
              });
          id(hp2)->queue_command(cmd);
